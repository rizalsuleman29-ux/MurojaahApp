import React, { useState, useEffect, useRef, useMemo } from 'react';
import { createClient } from '@supabase/supabase-js';
import { 
  BookOpen, Mic, Save, Trash2, Play, Pause, Lock, User, 
  CheckCircle, AlertTriangle, Clock, ArrowLeft, Book, LogOut, 
  Upload, X, ChevronLeft, ChevronRight, ChevronDown, ChevronUp, 
  Search, Volume2, VolumeX, ListMusic, PlayCircle, StopCircle, 
  MessageCircle, Power, Wallet, MoreVertical, Download, Gauge 
} from 'lucide-react';

// ==========================================
// 1. SUPABASE SETUP & CONFIGURATION
// ==========================================

const SUPABASE_URL = 'https://fcebcrjtzwrkjfalctzs.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZjZWJjcmp0endya2pmYWxjdHpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1ODI1NTksImV4cCI6MjA4NTE1ODU1OX0.5B84aFxYIzJTLMx4273z62crL8bbHvBC_tN5NK91gi4';

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Helper: Blob to Base64 (Masih digunakan untuk menyimpan audio kecil sebagai text)
const blobToBase64 = (blob) => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
};

// ==========================================
// 2. CONSTANTS
// ==========================================

const BASE_IMAGE_URL = 'https://android.quran.com/data/width_1024/page';
const TOTAL_PAGES = 604;
const AUDIO_BASE_URL = 'https://everyayah.com/data/Alafasy_128kbps';

// ==========================================
// 3. API SERVICES (QURAN) - TIDAK BERUBAH
// ==========================================

const fetchSurahList = async () => {
  try {
    const response = await fetch('https://api.quran.com/api/v4/chapters?language=id');
    const data = await response.json();
    return data.chapters;
  } catch (error) {
    console.error("Failed to fetch surahs", error);
    return [];
  }
};

const fetchPageData = async (pageNumber) => {
  try {
    const response = await fetch(`https://api.quran.com/api/v4/verses/by_page/${pageNumber}?fields=text_uthmani,juz_number`);
    const data = await response.json();
    return data.verses; 
  } catch (error) {
    console.error("Failed to fetch page data", error);
    return [];
  }
};

// ==========================================
// 4. UTILS & HELPERS
// ==========================================

const getPageUrl = (pageNumber) => {
  const paddedPage = pageNumber.toString().padStart(3, '0');
  return `${BASE_IMAGE_URL}${paddedPage}.png`;
};

const getAudioUrl = (verseKey) => {
  if (!verseKey) return null;
  const [surah, ayah] = verseKey.split(':');
  const paddedSurah = surah.padStart(3, '0');
  const paddedAyah = ayah.padStart(3, '0');
  return `${AUDIO_BASE_URL}/${paddedSurah}${paddedAyah}.mp3`;
};

// ==========================================
// 5. COMPONENTS
// ==========================================

// --- Component: Recording Item (Custom Player) ---
const RecordingItem = ({ rec, onDeleteRequest }) => {
    const [isPlaying, setIsPlaying] = useState(false);
    const [isMuted, setIsMuted] = useState(false);
    const [speed, setSpeed] = useState(1);
    const [showMenu, setShowMenu] = useState(false);
    const audioRef = useRef(null);

    const togglePlay = () => {
        if (!audioRef.current) return;
        if (isPlaying) {
            audioRef.current.pause();
        } else {
            audioRef.current.play();
        }
        setIsPlaying(!isPlaying);
    };

    const handleEnded = () => setIsPlaying(false);

    return (
        <div className="bg-gray-50 p-3 rounded-lg border border-gray-100 flex items-center justify-between gap-3 relative">
            <audio 
                ref={audioRef} 
                src={rec.audio_url} // Changed from audioUrl to audio_url (SQL standard)
                onEnded={handleEnded} 
                muted={isMuted}
                onPause={() => setIsPlaying(false)}
                onPlay={() => setIsPlaying(true)}
            />
            
            <button 
                type="button"
                onClick={togglePlay}
                className={`p-2.5 rounded-full shrink-0 transition shadow-sm ${isPlaying ? 'bg-orange-600 text-white' : 'bg-white text-orange-600 border border-orange-200'}`}
            >
                {isPlaying ? <Pause size={16} fill="currentColor"/> : <Play size={16} fill="currentColor"/>}
            </button>

            <div className="flex-1 min-w-0">
                <p className="text-xs font-bold text-gray-800 truncate">{rec.surah}</p>
                <p className="text-[10px] text-gray-500 font-medium">Ayat: <span className="text-orange-600">{rec.ayah_range || '-'}</span> • {new Date(rec.created_at).toLocaleDateString('id-ID')}</p>
            </div>

            <div className="flex items-center gap-1">
                <button 
                    type="button"
                    onClick={(e) => {
                        e.stopPropagation(); 
                        onDeleteRequest(rec.id);
                    }} 
                    className="p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-full transition z-10"
                    title="Hapus Rekaman"
                >
                    <Trash2 size={16}/>
                </button>

                <div className="relative">
                    <button 
                        type="button"
                        onClick={() => setShowMenu(!showMenu)} 
                        className="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full transition"
                    >
                        <MoreVertical size={16}/>
                    </button>

                    {showMenu && (
                        <>
                            <div className="fixed inset-0 z-40" onClick={() => setShowMenu(false)}></div>
                            <div className="absolute right-0 top-8 bg-white shadow-xl border border-gray-100 rounded-lg z-50 w-40 py-1 overflow-hidden animate-fade-in">
                                <a 
                                    href={rec.audio_url} 
                                    download={`murojaah-${rec.surah}.ogg`} 
                                    className="px-4 py-2.5 text-xs text-gray-700 hover:bg-gray-50 flex items-center gap-2 w-full transition"
                                    onClick={() => setShowMenu(false)}
                                >
                                    <Download size={14}/> Download
                                </a>
                                <button 
                                    type="button"
                                    onClick={() => { setIsMuted(!isMuted); setShowMenu(false); }} 
                                    className="w-full text-left px-4 py-2.5 text-xs text-gray-700 hover:bg-gray-50 flex items-center gap-2 transition"
                                >
                                    {isMuted ? <VolumeX size={14}/> : <Volume2 size={14}/>} {isMuted ? "Bunyikan" : "Bisukan"}
                                </button>
                                <button 
                                    type="button"
                                    onClick={() => { 
                                        const newSpeed = speed === 1 ? 1.5 : (speed === 1.5 ? 2 : 1);
                                        if(audioRef.current) audioRef.current.playbackRate = newSpeed;
                                        setSpeed(newSpeed);
                                        setShowMenu(false);
                                    }} 
                                    className="w-full text-left px-4 py-2.5 text-xs text-gray-700 hover:bg-gray-50 flex items-center gap-2 transition"
                                >
                                    <Gauge size={14}/> Kecepatan {speed}x
                                </button>
                            </div>
                        </>
                    )}
                </div>
            </div>
        </div>
    );
};

// --- Component: Audio Recorder (UNCHANGED) ---
const AudioRecorder = ({ onSave }) => {
  const [recording, setRecording] = useState(false);
  const [audioURL, setAudioURL] = useState(null);
  const [audioBlob, setAudioBlob] = useState(null);
  const [timer, setTimer] = useState(0);
  const mediaRecorderRef = useRef(null);
  const timerIntervalRef = useRef(null);
  const audioPlayerRef = useRef(null);

  const startRecording = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorderRef.current = new MediaRecorder(stream);
      const chunks = [];

      mediaRecorderRef.current.ondataavailable = (e) => chunks.push(e.data);
      mediaRecorderRef.current.onstop = () => {
        const blob = new Blob(chunks, { type: 'audio/ogg; codecs=opus' });
        const url = URL.createObjectURL(blob);
        setAudioURL(url);
        setAudioBlob(blob);
      };

      mediaRecorderRef.current.start();
      setRecording(true);
      setTimer(0);
      timerIntervalRef.current = setInterval(() => setTimer(t => t + 1), 1000);
    } catch (err) {
      alert("Gagal mengakses mikrofon. Pastikan izin diberikan.");
    }
  };

  const stopRecording = () => {
    if (mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive') {
      mediaRecorderRef.current.stop();
    }
    setRecording(false);
    if (timerIntervalRef.current) clearInterval(timerIntervalRef.current);
  };

  const handleSave = () => {
    if(audioBlob) {
      onSave(audioBlob, audioURL);
      setAudioURL(null);
      setAudioBlob(null);
    }
  };

  const formatTime = (seconds) => {
    const min = Math.floor(seconds / 60);
    const sec = seconds % 60;
    return `${min}:${sec < 10 ? '0' : ''}${sec}`;
  };

  useEffect(() => {
    return () => {
      if (timerIntervalRef.current) clearInterval(timerIntervalRef.current);
      if (mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive') {
        mediaRecorderRef.current.stop();
      }
    };
  }, []);

  return (
    <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-[0_-5px_20px_rgba(0,0,0,0.1)] p-4 pb-6 z-[100] animate-slide-up">
      <div className="max-w-md mx-auto flex items-center justify-between">
        {recording ? (
          <div className="flex items-center gap-4 w-full bg-red-50 p-3 rounded-full border border-red-100">
            <div className="w-3 h-3 rounded-full bg-red-500 animate-pulse ml-2"></div>
            <span className="font-mono text-red-600 font-bold text-lg">{formatTime(timer)}</span>
            <button 
              type="button"
              onClick={stopRecording} 
              className="ml-auto bg-white text-red-600 px-6 py-2 rounded-full text-sm font-bold shadow-sm active:scale-95 transition"
            >
              Stop
            </button>
          </div>
        ) : audioURL ? (
          <div className="flex items-center gap-3 w-full">
            <div className="flex-1 bg-gray-100 rounded-full px-4 py-2 flex items-center">
                <Play size={18} className="text-gray-500 mr-2" />
                <audio ref={audioPlayerRef} src={audioURL} controls className="h-8 w-full opacity-50" />
            </div>
            <button type="button" onClick={handleSave} className="bg-emerald-600 text-white w-12 h-12 rounded-full flex items-center justify-center hover:bg-emerald-700 active:scale-95 transition shadow-lg shadow-emerald-200">
              <Save size={20} />
            </button>
            <button type="button" onClick={() => { setAudioURL(null); setAudioBlob(null); }} className="bg-gray-100 text-gray-600 w-12 h-12 rounded-full flex items-center justify-center hover:bg-gray-200 active:scale-95 transition">
              <Trash2 size={20} />
            </button>
          </div>
        ) : (
          <button 
            type="button"
            onClick={startRecording} 
            className="w-full bg-emerald-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-emerald-200 flex items-center justify-center gap-3 hover:bg-emerald-700 active:scale-[0.98] transition"
          >
            <div className="bg-white/20 p-2 rounded-full">
                <Mic size={24} />
            </div>
            Mulai Rekam Hafalan
          </button>
        )}
      </div>
    </div>
  );
};

// --- Component: Modal Delete & Save (Visuals Unchanged) ---
const DeleteConfirmationModal = ({ isOpen, onClose, onConfirm }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 bg-black/60 z-[120] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
      <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl text-center">
        <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600">
            <Trash2 size={32} />
        </div>
        <h3 className="text-lg font-bold text-gray-800 mb-2">Hapus Rekaman?</h3>
        <p className="text-sm text-gray-500 mb-6">Anda yakin ingin menghapus rekaman ini? Tindakan ini tidak dapat dibatalkan.</p>
        <div className="flex gap-3">
            <button onClick={onClose} className="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition">Tidak</button>
            <button onClick={onConfirm} className="flex-1 py-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 transition shadow-lg shadow-red-200">Hapus</button>
        </div>
      </div>
    </div>
  );
};

const SaveModal = ({ isOpen, onClose, onConfirm, isSaving }) => {
  const [surahName, setSurahName] = useState('');
  const [ayahRange, setAyahRange] = useState('');

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/60 z-[110] flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm">
      <div className="bg-white rounded-t-2xl sm:rounded-2xl w-full max-w-sm max-h-[85vh] overflow-y-auto p-6 shadow-2xl animate-slide-up sm:animate-fade-in">
        <div className="flex justify-between items-center mb-6">
            <h3 className="text-lg font-bold text-gray-800">Simpan Hafalan</h3>
            <button onClick={onClose} className="p-1 bg-gray-100 rounded-full text-gray-500"><X size={18}/></button>
        </div>
        <div className="space-y-4">
          <div>
            <label className="text-xs font-bold text-gray-400 uppercase tracking-wider">Nama Surah / Catatan</label>
            <input type="text" className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 mt-1 focus:ring-2 focus:ring-emerald-500 outline-none font-medium" placeholder="Contoh: Al-Mulk / Hal 562" value={surahName} onChange={(e) => setSurahName(e.target.value)} />
          </div>
          <div>
            <label className="text-xs font-bold text-gray-400 uppercase tracking-wider">Ayat (Awal - Akhir)</label>
            <input type="text" className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 mt-1 focus:ring-2 focus:ring-emerald-500 outline-none font-medium" placeholder="Contoh: 1-10" value={ayahRange} onChange={(e) => setAyahRange(e.target.value)} />
          </div>
          <div className="pt-4 flex gap-3">
            <button disabled={isSaving} onClick={() => onConfirm(surahName, ayahRange)} className="w-full py-3.5 bg-emerald-600 text-white font-bold rounded-xl hover:bg-emerald-700 active:scale-95 transition shadow-lg shadow-emerald-200 flex items-center justify-center gap-2">
              {isSaving ? (
                <><div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>Mengupload...</>
              ) : "Simpan Rekaman"}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

// --- Component: Quran Reader (LOGIC MIGRATED TO SUPABASE) ---
const QuranReader = ({ user, subscription }) => {
  const [surahs, setSurahs] = useState([]);
  const [currentPage, setCurrentPage] = useState(null); 
  const [imageLoading, setImageLoading] = useState(true);
  const [showSaveModal, setShowSaveModal] = useState(false);
  const [tempAudio, setTempAudio] = useState(null);
  const [isSaving, setIsSaving] = useState(false);
  const [pageHeader, setPageHeader] = useState({ surah: '', juz: '' });
  const [pageVerses, setPageVerses] = useState([]); 
  const [playingVerse, setPlayingVerse] = useState(null); 
  const [isPlayingAll, setIsPlayingAll] = useState(false); 
  const [isAudioPanelOpen, setIsAudioPanelOpen] = useState(false); 
  const audioRef = useRef(new Audio());

  // Recordings
  const [myRecordings, setMyRecordings] = useState([]);
  const [isRecordingsPanelOpen, setIsRecordingsPanelOpen] = useState(false);
  const [deleteConfirm, setDeleteConfirm] = useState({ isOpen: false, id: null });
  
  const pageTopRef = useRef(null);

  useEffect(() => {
    fetchSurahList().then(setSurahs);
  }, []);

  // --- SUPABASE: Fetch Realtime Recordings ---
  useEffect(() => {
    if (!user) return;

    const fetchRecordings = async () => {
        const { data, error } = await supabase
            .from('recordings')
            .select('*')
            .eq('user_id', user.id)
            .order('created_at', { ascending: false });
        
        if (!error && data) setMyRecordings(data);
    };

    fetchRecordings();

    // Setup Realtime Subscription
    const subscriptionChannel = supabase
        .channel('public:recordings')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'recordings', filter: `user_id=eq.${user.id}` }, (payload) => {
            fetchRecordings(); // Refresh list on change
        })
        .subscribe();

    return () => supabase.removeChannel(subscriptionChannel);
  }, [user]);

  // Page Logic (Unchanged)
  useEffect(() => {
    if (currentPage) {
      setImageLoading(true);
      if(pageTopRef.current) pageTopRef.current.scrollTop = 0;
      audioRef.current.pause();
      setPlayingVerse(null);
      setIsPlayingAll(false);
      setIsAudioPanelOpen(false);
      setIsRecordingsPanelOpen(false);

      fetchPageData(currentPage).then(verses => {
        setPageVerses(verses);
        if (verses.length > 0) {
            const firstVerse = verses[0];
            const surahId = parseInt(firstVerse.verse_key.split(':')[0]);
            const surahInfo = surahs.find(s => s.id === surahId);
            setPageHeader({
                surah: surahInfo ? surahInfo.name_simple : `Surah ${surahId}`,
                juz: firstVerse.juz_number ? `Juz ${firstVerse.juz_number}` : '' 
            });
        }
      });
    }
  }, [currentPage, surahs]);

  useEffect(() => {
    const onAudioEnded = () => {
        if (isPlayingAll && playingVerse) {
            const currentIndex = pageVerses.findIndex(v => v.verse_key === playingVerse);
            if (currentIndex !== -1 && currentIndex < pageVerses.length - 1) {
                const nextVerse = pageVerses[currentIndex + 1];
                const url = getAudioUrl(nextVerse.verse_key);
                if(url) {
                    audioRef.current.src = url;
                    audioRef.current.play().catch(e => console.error("Play error:", e));
                    setPlayingVerse(nextVerse.verse_key);
                } else {
                    setIsPlayingAll(false);
                    setPlayingVerse(null);
                }
            } else {
                setIsPlayingAll(false);
                setPlayingVerse(null);
            }
        } else {
            setPlayingVerse(null);
        }
    };
    const audio = audioRef.current;
    audio.addEventListener('ended', onAudioEnded);
    return () => audio.removeEventListener('ended', onAudioEnded);
  }, [isPlayingAll, playingVerse, pageVerses]);

  const handleSelectSurah = (surah) => {
    if (surah.pages && surah.pages.length > 0) {
      setCurrentPage(surah.pages[0]);
    } else {
        setCurrentPage(1); 
    }
  };

  const handleNextPage = () => { if (currentPage < TOTAL_PAGES) setCurrentPage(p => p + 1); };
  const handlePrevPage = () => { if (currentPage > 1) setCurrentPage(p => p - 1); };

  const handlePlayVerse = (verseKey) => {
      setIsPlayingAll(false);
      const url = getAudioUrl(verseKey);
      if(url) {
          if (playingVerse === verseKey) {
              audioRef.current.pause();
              setPlayingVerse(null);
          } else {
              audioRef.current.src = url;
              audioRef.current.play();
              setPlayingVerse(verseKey);
          }
      }
  };

  const handlePlayAll = () => {
      if (pageVerses.length === 0) return;
      if (isPlayingAll) {
          audioRef.current.pause();
          setPlayingVerse(null);
          setIsPlayingAll(false);
      } else {
          setIsPlayingAll(true);
          const firstVerse = pageVerses[0];
          const url = getAudioUrl(firstVerse.verse_key);
          if (url) {
              audioRef.current.src = url;
              audioRef.current.play();
              setPlayingVerse(firstVerse.verse_key);
          }
      }
  };

  const handleSaveAudio = (blob, url) => {
    setTempAudio({ blob, url });
    setShowSaveModal(true);
  };

  // --- SUPABASE: Delete Logic ---
  const requestDelete = (id) => setDeleteConfirm({ isOpen: true, id: id });
  
  const confirmDelete = async () => {
      if (deleteConfirm.id && user) {
          try {
            const { error } = await supabase
                .from('recordings')
                .delete()
                .eq('id', deleteConfirm.id)
                .eq('user_id', user.id);
            
            if (error) throw error;
          } catch (error) {
            console.error("Error deleting doc:", error);
            alert("Gagal menghapus.");
          }
      }
      setDeleteConfirm({ isOpen: false, id: null });
  };

  // --- SUPABASE: Save Logic ---
  const confirmSave = async (surahName, range) => {
    if (!user || !tempAudio) return;
    if (tempAudio.blob.size > 800000) {
        alert("Maaf, ukuran file rekaman terlalu besar untuk demo ini (Max 800KB).");
        return;
    }

    setIsSaving(true);
    try {
        const base64Audio = await blobToBase64(tempAudio.blob);
        
        const { error } = await supabase.from('recordings').insert({
            user_id: user.id,
            surah: surahName || `${pageHeader.surah}`,
            ayah_range: range, // Maps to 'ayah_range' in SQL
            audio_url: base64Audio, // Storing base64 text
        });

        if (error) throw error;
        
        setShowSaveModal(false);
        setTempAudio(null);
        alert("Hafalan berhasil disimpan ke Cloud!");
    } catch (error) {
        console.error("Error saving recording:", error);
        alert("Gagal menyimpan: " + error.message);
    } finally {
        setIsSaving(false);
    }
  };

  const isPremium = subscription && (subscription.status === 'active' || subscription.status === 'trial');

  return (
    <div className="flex flex-col h-full bg-gray-100">
      <div className="bg-white border-b px-4 py-3 flex items-center justify-between shrink-0 shadow-sm z-30 sticky top-0">
        {currentPage ? (
          <button onClick={() => { setCurrentPage(null); audioRef.current.pause(); }} className="text-gray-600 flex items-center gap-2 text-sm font-bold bg-gray-50 px-3 py-1.5 rounded-lg active:bg-gray-100 transition">
            <ArrowLeft size={18} /> Daftar Surah
          </button>
        ) : (
          <div className="flex items-center gap-2">
            <div className="bg-emerald-100 p-1.5 rounded-lg">
                <BookOpen size={20} className="text-emerald-700"/>
            </div>
            <h1 className="text-lg font-bold text-gray-800">Al-Qur'an</h1>
          </div>
        )}
        {isPremium && <span className="text-[10px] bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full font-bold border border-emerald-200">PREMIUM CLOUD</span>}
      </div>

      {currentPage && (
        <div className="bg-white border-b border-emerald-100 w-full flex flex-col justify-center shrink-0 z-20 shadow-sm animate-fade-in">
            <div className="flex justify-between items-center px-4 py-3 bg-emerald-50 text-emerald-900">
                <span className="font-bold text-sm flex items-center gap-1.5">
                    <Book size={14} className="text-emerald-600"/> {pageHeader.surah || 'Memuat...'}
                </span>
                <span className="font-bold text-xs bg-emerald-100 px-2 py-1 rounded text-emerald-800">
                    {pageHeader.juz || '...'}
                </span>
            </div>
        </div>
      )}

      <div ref={pageTopRef} className="flex-1 overflow-y-auto pb-48 scroll-smooth bg-[#f4f4f4] relative">
        {!currentPage ? (
            <div className="p-4 grid gap-3 max-w-3xl mx-auto">
                <div className="mb-2">
                    <div className="bg-white border border-gray-200 rounded-xl p-3 flex items-center gap-2 text-gray-400 text-sm shadow-sm">
                        <Search size={18}/>
                        <span>Cari Surah...</span>
                    </div>
                </div>
                {surahs.map(surah => (
                <div key={surah.id} onClick={() => handleSelectSurah(surah)} 
                    className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between cursor-pointer active:scale-[0.99] active:bg-emerald-50 transition touch-manipulation">
                    <div className="flex items-center gap-4">
                    <div className="w-10 h-10 bg-emerald-50 rounded-xl flex items-center justify-center text-emerald-700 font-bold text-sm relative overflow-hidden">
                        <span className="relative z-10">{surah.id}</span>
                    </div>
                    <div>
                        <h3 className="font-bold text-gray-800">{surah.name_simple}</h3>
                        <p className="text-xs text-gray-500 font-medium">{surah.translated_name.name} • {surah.verses_count} Ayat</p>
                    </div>
                    </div>
                    <span className="font-quran text-2xl text-gray-400 font-serif">{surah.name_arabic}</span>
                </div>
                ))}
            </div>
        ) : (
            <div className="min-h-full flex flex-col items-center bg-[#f4f4f4] pt-4">
                <div className="w-full max-w-lg relative px-2 sm:px-0 mb-6">
                    {imageLoading && (
                      <div className="absolute inset-0 flex flex-col items-center justify-center bg-white min-h-[500px] z-0 rounded-lg shadow-sm border border-gray-200 mx-2">
                         <div className="w-8 h-8 border-4 border-emerald-200 border-t-emerald-600 rounded-full animate-spin mb-2"></div>
                         <span className="text-xs text-gray-400 font-medium">Memuat Halaman...</span>
                      </div>
                    )}
                    <img 
                        src={getPageUrl(currentPage)} 
                        alt={`Halaman ${currentPage}`}
                        className={`w-full h-auto rounded-lg shadow-md border border-gray-200 transition-opacity duration-300 relative z-10 ${imageLoading ? 'opacity-0 min-h-[500px]' : 'opacity-100'}`}
                        onLoad={() => setImageLoading(false)}
                        onError={(e) => {
                            e.target.onerror = null; 
                            alert("Gagal memuat gambar halaman. Coba lagi.");
                            setImageLoading(false);
                        }}
                    />
                </div>

                <div className="w-full max-w-lg flex justify-between items-center mb-6 gap-3 px-4">
                    <button onClick={handleNextPage} disabled={currentPage >= TOTAL_PAGES} className="flex-1 bg-white border border-gray-200 py-3 rounded-xl font-bold text-gray-600 shadow-sm flex items-center justify-center gap-2 active:bg-gray-50 disabled:opacity-50">
                        <ChevronLeft size={18}/> Selanjutnya
                    </button>
                    <button onClick={handlePrevPage} disabled={currentPage <= 1} className="flex-1 bg-white border border-gray-200 py-3 rounded-xl font-bold text-gray-600 shadow-sm flex items-center justify-center gap-2 active:bg-gray-50 disabled:opacity-50">
                        Sebelumnya <ChevronRight size={18}/> 
                    </button>
                </div>

                {isPremium && (
                    <div className="w-full max-w-lg px-3 mb-4">
                        <button 
                            onClick={() => setIsRecordingsPanelOpen(!isRecordingsPanelOpen)}
                            className="w-full bg-orange-50 border border-orange-100 py-3 rounded-xl font-bold text-orange-800 shadow-sm flex items-center justify-center gap-2 mb-2 active:scale-[0.99] transition hover:bg-orange-100"
                        >
                            {isRecordingsPanelOpen ? <ChevronUp size={18}/> : <ChevronDown size={18}/>}
                            <span className="text-xs sm:text-sm">{isRecordingsPanelOpen ? "Tutup Rekaman Saya" : "Buka Rekaman Saya"}</span>
                        </button>
                        {isRecordingsPanelOpen && (
                            <div className="bg-white rounded-xl shadow-sm border border-orange-100 overflow-hidden animate-slide-up">
                                <div className="max-h-[250px] overflow-y-auto p-2 space-y-2">
                                    {myRecordings.length === 0 ? (
                                        <p className="text-center text-[10px] text-gray-400 italic py-4">Belum ada rekaman di cloud.</p>
                                    ) : (
                                        myRecordings.map(rec => (
                                            <RecordingItem key={rec.id} rec={rec} onDeleteRequest={requestDelete} />
                                        ))
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                )}

                <div className="w-full max-w-lg px-3 mb-10">
                    <button onClick={() => setIsAudioPanelOpen(!isAudioPanelOpen)} className="w-full bg-white border border-gray-200 py-3 rounded-xl font-bold text-emerald-700 shadow-sm flex items-center justify-center gap-2 mb-3 active:scale-[0.99] transition hover:bg-emerald-50">
                        {isAudioPanelOpen ? <ChevronUp size={20}/> : <ChevronDown size={20}/>}
                        <span className="text-xs sm:text-sm">{isAudioPanelOpen ? "Tutup Audio Ayat" : "Putar Audio Ayat (Syaikh Misyari Rasyid Alafasy)"}</span>
                    </button>
                    {isAudioPanelOpen && (
                        <div className="bg-white rounded-xl shadow-md border border-emerald-100 overflow-hidden animate-slide-up">
                            <div className="bg-emerald-50 px-4 py-3 border-b border-emerald-100 flex items-center justify-between">
                                <div className="flex items-center gap-2">
                                    <ListMusic size={16} className="text-emerald-600"/>
                                    <h3 className="text-xs font-bold text-emerald-800 uppercase tracking-wide">Daftar Ayat</h3>
                                </div>
                                <button onClick={handlePlayAll} disabled={pageVerses.length === 0} className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full text-[10px] font-bold transition shadow-sm ${isPlayingAll ? 'bg-red-100 text-red-600 hover:bg-red-200' : 'bg-emerald-600 text-white hover:bg-emerald-700'}`}>
                                    {isPlayingAll ? <StopCircle size={14}/> : <PlayCircle size={14}/>} {isPlayingAll ? 'Stop' : 'Putar Semua'}
                                </button>
                            </div>
                            <div className="max-h-[300px] overflow-y-auto p-2 grid grid-cols-4 sm:grid-cols-5 gap-2">
                                {pageVerses.length === 0 ? (
                                    <div className="col-span-4 p-4 text-center text-xs text-gray-400">Memuat data ayat...</div>
                                ) : (
                                    pageVerses.map(verse => {
                                        const ayahNum = verse.verse_key.split(':')[1];
                                        const isPlaying = playingVerse === verse.verse_key;
                                        return (
                                            <button key={verse.id} onClick={() => handlePlayVerse(verse.verse_key)} className={`flex flex-col items-center justify-center p-2 rounded-lg border transition relative overflow-hidden ${isPlaying ? 'bg-emerald-600 text-white border-emerald-600 shadow-md transform scale-105' : 'bg-white text-gray-600 border-gray-100 hover:border-emerald-200 hover:bg-emerald-50'}`}>
                                                {isPlaying && <div className="absolute inset-0 bg-white/10 animate-pulse"></div>}
                                                <span className="text-lg font-bold mb-1">{ayahNum}</span>
                                                {isPlaying ? <Pause size={12} fill="currentColor"/> : <Play size={12} fill="currentColor" />}
                                            </button>
                                        );
                                    })
                                )}
                            </div>
                        </div>
                    )}
                </div>
            </div>
        )}
      </div>
      
      {isPremium && currentPage && <AudioRecorder onSave={handleSaveAudio} />}
      <SaveModal isOpen={showSaveModal} onClose={() => setShowSaveModal(false)} onConfirm={confirmSave} isSaving={isSaving} />
      <DeleteConfirmationModal isOpen={deleteConfirm.isOpen} onClose={() => setDeleteConfirm({isOpen:false,id:null})} onConfirm={confirmDelete} />
    </div>
  );
};

// --- Component: Payment & Subscription (LOGIC MIGRATED TO SUPABASE) ---
const SubscriptionDashboard = ({ user, subscription, onLogout }) => {
  const [proofFile, setProofFile] = useState(null);
  const [phoneNumber, setPhoneNumber] = useState('');
  const [infaqAmount, setInfaqAmount] = useState('20000');
  const [showPayment, setShowPayment] = useState(false);
  
  const daysLeft = useMemo(() => {
    if (!subscription || !subscription.expires_at) return 0;
    const end = new Date(subscription.expires_at);
    const now = new Date();
    const diffTime = Math.abs(end - now);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return end < now ? 0 : diffDays;
  }, [subscription]);

  // --- SUPABASE: Upload Proof Logic ---
  const handleUpload = async () => {
    if(!proofFile) return alert("Pilih file bukti transfer dahulu.");
    if(!phoneNumber) return alert("Mohon isi nomor HP/WA Anda.");
    
    try {
        // 1. Upload Image to Storage Bucket
        const fileExt = proofFile.name.split('.').pop();
        const fileName = `${user.id}-${Math.random()}.${fileExt}`;
        
        const { error: uploadError } = await supabase.storage
            .from('payment-proofs')
            .upload(fileName, proofFile);

        if (uploadError) throw uploadError;

        // 2. Update Subscription Status
        const { error: dbError } = await supabase
            .from('subscriptions')
            .upsert({
                user_id: user.id,
                status: 'pending_verification',
                expires_at: subscription?.expires_at || new Date().toISOString(),
                phone: phoneNumber,
                infaq_amount: parseInt(infaqAmount),
                proof_url: fileName,
                updated_at: new Date().toISOString()
            });

        if (dbError) throw dbError;
        
        alert("Bukti terkirim ke Cloud! Admin akan memverifikasi data Anda.");
    } catch (error) {
        console.error("Error upload:", error);
        alert("Gagal mengupload bukti: " + error.message);
    }
  };

  const isExpired = subscription?.status === 'expired' || (subscription?.status !== 'pending_verification' && daysLeft === 0);
  const isTrial = subscription?.status === 'trial';
  const isPending = subscription?.status === 'pending_verification';
  const isActive = subscription?.status === 'active';
  const isPaymentSectionVisible = (showPayment || isExpired || (isTrial && daysLeft < 3)) && !isPending;

  return (
    <div className="h-full bg-gray-50 p-4 pb-32 overflow-y-auto">
      <div className="flex justify-between items-center mb-6 pt-2">
        <h1 className="text-2xl font-bold text-gray-800">Akun Saya</h1>
        <button onClick={onLogout} className="text-red-500 text-xs font-bold flex items-center gap-1 bg-red-50 px-3 py-2 rounded-full active:scale-95 transition">
          <LogOut size={14} /> KELUAR
        </button>
      </div>

      <div className="bg-gradient-to-br from-emerald-600 to-emerald-800 rounded-3xl p-6 text-white shadow-xl shadow-emerald-200 mb-6 relative overflow-hidden">
        <div className="relative z-10">
          <p className="text-emerald-100 text-sm mb-1 font-medium">Assalamu'alaikum,</p>
          <p className="font-bold text-lg truncate pr-10">{user.email || 'Pengguna'}</p>
          <div className="mt-4 flex items-center justify-between">
             <div className="inline-flex items-center gap-2 bg-white/10 px-3 py-1 rounded-full backdrop-blur-sm border border-white/20">
                <Power size={12} className={isActive ? "text-green-400" : "text-yellow-400"} />
                <span className="text-xs font-medium uppercase tracking-wider">{isActive ? "ON" : "OFF/Trial"}</span>
             </div>
             {!isPending && (
                 <button onClick={() => setShowPayment(!showPayment)} className="bg-white text-emerald-800 px-3 py-1.5 rounded-full text-xs font-bold shadow-md active:scale-95 transition flex items-center gap-1">
                    <Wallet size={12}/> {showPayment ? "Tutup" : "Aktifkan Masa 1 Bulan"}
                 </button>
             )}
          </div>
        </div>
        <BookOpen className="absolute -right-6 -bottom-8 text-white opacity-10 rotate-12" size={140} />
      </div>

      <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
        <div className="flex justify-between items-center mb-4">
            <h3 className="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Status Langganan</h3>
            {isPending && <span className="bg-yellow-100 text-yellow-700 text-[10px] font-bold px-2 py-0.5 rounded">Verifikasi</span>}
        </div>
        <div className="flex items-center gap-4 mb-4">
          <div className={`w-14 h-14 rounded-full flex items-center justify-center text-2xl shrink-0 ${
            isActive ? 'bg-emerald-100 text-emerald-600' :
            isTrial ? 'bg-blue-100 text-blue-600' :
            isPending ? 'bg-yellow-100 text-yellow-600' :
            'bg-red-100 text-red-600'
          }`}>
            {isActive || isTrial ? <CheckCircle size={28} /> : isPending ? <Clock size={28} /> : <AlertTriangle size={28} />}
          </div>
          <div>
            <p className="font-bold text-gray-800 text-lg">
              {isTrial ? 'Masa Percobaan' : isActive ? 'Premium Aktif' : isPending ? 'Menunggu Verifikasi' : 'Tidak Aktif'}
            </p>
            {(isActive || isTrial) && (
              <p className="text-sm text-gray-500 mt-1">Sisa waktu: <span className="text-emerald-600 font-bold bg-emerald-50 px-2 py-0.5 rounded text-xs">{daysLeft} Hari</span></p>
            )}
          </div>
        </div>

        {isPaymentSectionVisible && (
          <div className="mt-6 border-t border-gray-100 pt-6 animate-fade-in">
            <h4 className="font-bold text-sm text-gray-700 mb-3">Informasi Pembayaran</h4>
            <div className="bg-gray-50 p-4 rounded-xl border border-gray-100 relative group mb-4">
                <p className="text-[10px] text-gray-400 font-bold uppercase mb-1">Bank Muamalat</p>
                <div className="flex justify-between items-center">
                  <span className="font-mono font-bold text-xl text-gray-800 tracking-wide">8110066306</span>
                  <button className="text-emerald-600 text-[10px] font-bold bg-emerald-100 px-3 py-1.5 rounded-md active:scale-90 transition" onClick={() => navigator.clipboard.writeText('8110066306')}>SALIN</button>
                </div>
                <p className="text-xs text-gray-500 mt-1 font-medium">a.n. Rizal Suleman</p>
            </div>
            <div className="space-y-4 mb-6">
                <div>
                    <label className="block text-xs font-bold text-gray-700 mb-2 uppercase">Nominal Infaq</label>
                    <div className="flex gap-2">
                        <button onClick={() => setInfaqAmount('20000')} className={`flex-1 py-3 rounded-xl border font-bold text-sm transition ${infaqAmount === '20000' ? 'bg-emerald-600 text-white border-emerald-600' : 'bg-white text-gray-600 border-gray-200'}`}>Rp 20.000</button>
                        <div className="flex-[1.5] relative">
                            <span className="absolute left-3 top-3 text-gray-400 text-sm">Rp</span>
                            <input type="number" value={infaqAmount} onChange={(e) => setInfaqAmount(e.target.value)} className="w-full pl-8 pr-4 py-3 rounded-xl border border-gray-200 text-gray-800 font-bold focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="Lainnya"/>
                        </div>
                    </div>
                </div>
                <div>
                    <label className="block text-xs font-bold text-gray-700 mb-2 uppercase">Nomor WA Aktif</label>
                    <input type="tel" value={phoneNumber} onChange={(e) => setPhoneNumber(e.target.value)} className="w-full px-4 py-3 rounded-xl border border-gray-200 text-gray-800 focus:ring-2 focus:ring-emerald-500 outline-none bg-white" placeholder="Contoh: 08123456789"/>
                </div>
                <div>
                    <label className="block text-xs font-bold text-gray-700 mb-2 uppercase">Upload Bukti Transfer</label>
                    <div className="relative">
                        <input type="file" accept="image/*" onChange={(e) => setProofFile(e.target.files[0])} className="block w-full text-sm text-gray-500 file:mr-4 file:py-3 file:px-6 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100 cursor-pointer bg-white border border-gray-200 rounded-full"/>
                        <div className="absolute right-4 top-3 text-emerald-600 pointer-events-none"><Upload size={18} /></div>
                    </div>
                </div>
            </div>
            <button onClick={handleUpload} disabled={!proofFile || !phoneNumber} className="w-full bg-emerald-600 text-white py-4 rounded-xl font-bold hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed transition shadow-lg shadow-emerald-200 active:scale-[0.98]">Kirim Konfirmasi</button>
            <a href="https://wa.me/6287815234810" target="_blank" rel="noreferrer" className="mt-3 w-full bg-white text-green-600 border border-green-200 py-3 rounded-xl font-bold hover:bg-green-50 transition flex items-center justify-center gap-2"><MessageCircle size={18} /> Hubungi Admin via WhatsApp</a>
          </div>
        )}
        {isPending && (
             <div className="bg-yellow-50 text-yellow-800 p-4 rounded-xl text-sm text-center border border-yellow-100 flex flex-col items-center gap-2">
                 <div className="bg-yellow-100 p-2 rounded-full"><Clock size={20} /></div>
                 <p className="font-medium">Mohon tunggu, admin sedang memverifikasi bukti transfer Anda.</p>
             </div>
        )}
      </div>
      <div className="text-center pb-8">
        <p className="text-[10px] text-gray-300 font-mono">Tenant ID: {user?.tenant_id || user?.id.substring(0,6)}</p>
      </div>
    </div>
  );
};

// --- Component: Login (LOGIC MIGRATED TO SUPABASE) ---
const LoginPage = ({ onLogin, onBack }) => {
  const [email, setEmail] = useState('');
  const [loading, setLoading] = useState(false);

  // --- SUPABASE: Auth Logic ---
  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);

    try {
        // MENGGUNAKAN ANONYMOUS LOGIN SUPABASE
        // Note: Pastikan "Enable Anonymous Sign-ins" aktif di Dashboard Supabase > Auth
        // Jika tidak aktif, ini akan error. 
        // Alternatif: Gunakan signUp dengan email/password random jika Anon non-aktif.
        
        // Coba Login Anonymously
        let { data, error } = await supabase.auth.signInAnonymously();
        
        // Jika belum ada user / pertama kali
        if (error) {
           // Fallback mechanism: Jika Anonymous dimatikan di dashboard, 
           // kita buatkan user dummy based on email input untuk demo.
           const dummyPass = "password123"; // Password default untuk demo
           const { data: upData, error: upError } = await supabase.auth.signUp({
               email: email,
               password: dummyPass
           });
           
           if (upError) {
               // Jika sudah terdaftar, coba login
               const { data: inData, error: inError } = await supabase.auth.signInWithPassword({
                   email: email,
                   password: dummyPass
               });
               if(inError) throw inError;
               data = inData;
           } else {
               data = upData;
           }
        }

        const user = data.user;
        if (!user) throw new Error("No user returned");

        // Profile handling ditangani oleh Trigger SQL (handle_new_user) 
        // tapi kita bisa fetch manual untuk memastikan
        const { data: profile } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', user.id)
            .single();

        onLogin({ ...user, ...profile });

    } catch (error) {
        console.error("Login failed:", error);
        alert("Login error: " + error.message);
    } finally {
        setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-white flex flex-col p-6 relative">
      <button onClick={onBack} className="absolute top-6 left-6 text-gray-400 p-2 hover:bg-gray-50 rounded-full transition">
        <ArrowLeft size={24} />
      </button>
      
      <div className="flex-1 flex flex-col justify-center max-w-sm mx-auto w-full animate-slide-up">
        <div className="text-center mb-10">
          <div className="w-20 h-20 bg-gradient-to-tr from-emerald-100 to-emerald-50 rounded-3xl flex items-center justify-center mx-auto mb-6 text-emerald-600 shadow-xl shadow-emerald-50">
            <User size={40} strokeWidth={1.5} />
          </div>
          <h2 className="text-3xl font-bold text-gray-900 mb-2">Masuk Akun</h2>
          <p className="text-gray-500 leading-relaxed">Simpan progres hafalan dan akses murojaah mandiri Anda di Cloud.</p>
          <div className="mt-6 bg-emerald-50 p-4 rounded-xl border border-emerald-100 text-left">
            <h3 className="font-bold text-emerald-800 text-sm mb-2 uppercase tracking-wide">Halaman Premium</h3>
            <p className="text-xs text-emerald-700 leading-relaxed">
                Masa uji coba (trial) selama 7 hari. Anda dapat memanfaatkan masa percobaan ini hingga berakhir atau memilih untuk langsung mengaktifkan langganan premium selama 1 bulan melalui tombol akun, silahkan login terlebih dahulu.
            </p>
          </div>
        </div>

        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-xs font-bold text-gray-700 mb-1.5 uppercase tracking-wide ml-1">Email</label>
            <input 
              type="email" 
              required
              className="w-full bg-gray-50 border border-gray-200 rounded-2xl px-5 py-4 focus:ring-2 focus:ring-emerald-500 focus:bg-white outline-none transition font-medium"
              placeholder="nama@email.com"
              value={email}
              onChange={e => setEmail(e.target.value)}
            />
          </div>
          <button 
            disabled={loading}
            className="w-full bg-emerald-600 text-white font-bold py-4 rounded-2xl hover:bg-emerald-700 transition shadow-lg shadow-emerald-200 disabled:opacity-70 flex items-center justify-center gap-2 active:scale-[0.98]"
          >
            {loading ? (
                <><div className="w-4 h-4 border-2 border-white/50 border-t-white rounded-full animate-spin"></div><span>Menghubungkan Supabase...</span></>
            ) : 'Masuk / Daftar Otomatis'}
          </button>
        </form>
        
        <div className="mt-8 text-center">
             <p className="text-xs text-gray-400 mb-2">Belum punya akun? Otomatis dibuatkan.</p>
             <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 text-left">
                <p className="text-xs text-blue-800 leading-relaxed">
                    <strong>Note:</strong> Menggunakan Supabase Cloud Database. Data Anda aman tersimpan online dengan Row Level Security.
                </p>
             </div>
        </div>
      </div>
    </div>
  );
};

// ==========================================
// 6. MAIN APP CONTAINER
// ==========================================

export default function App() {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('landing');
  const [subscription, setSubscription] = useState(null);
  const [activeTab, setActiveTab] = useState('quran'); 
  const [isInitializing, setIsInitializing] = useState(true);

  // --- SUPABASE: Auth State Listener ---
  useEffect(() => {
    // Check Current Session
    const checkSession = async () => {
        const { data: { session } } = await supabase.auth.getSession();
        await handleAuthChange(session);
        setIsInitializing(false);
    };

    checkSession();

    // Listen for changes
    const { data: { subscription } } = supabase.auth.onAuthStateChange(async (_event, session) => {
        await handleAuthChange(session);
    });

    return () => subscription.unsubscribe();
  }, []);

  const handleAuthChange = async (session) => {
    if (session?.user) {
        try {
            // Fetch Profile
            const { data: profile } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', session.user.id)
                .single();
            
            // Fetch Subscription
            const { data: sub } = await supabase
                .from('subscriptions')
                .select('*')
                .eq('user_id', session.user.id)
                .single();

            setUser({ ...session.user, ...profile });
            setSubscription(sub || { status: 'trial', expires_at: new Date(Date.now() + 7*24*60*60*1000).toISOString() });
            
            // Jika user baru login, set view ke app
            setView(prev => prev === 'landing' ? 'app' : prev);
        } catch (e) {
            console.error("Error fetching user details", e);
        }
    } else {
        setUser(null);
        setSubscription(null);
        setView('landing');
    }
  };

  const handleLogin = (userData) => {
    setUser(userData);
    setView('app');
  };

  const handleLogout = async () => {
    await supabase.auth.signOut();
    setUser(null);
    setSubscription(null);
    setView('landing');
  };

  if (isInitializing) {
      return (
        <div className="min-h-screen flex items-center justify-center bg-white">
            <div className="flex flex-col items-center gap-4">
                <div className="w-10 h-10 border-4 border-emerald-200 border-t-emerald-600 rounded-full animate-spin"></div>
                <span className="text-emerald-800 font-bold text-sm">Memuat Cloud Data...</span>
            </div>
        </div>
      );
  }

  // Views Logic (UNCHANGED VISUALS)
  if (view === 'landing') {
    return (
      <div className="min-h-screen bg-white font-sans selection:bg-emerald-100">
        <style>{`
          @import url('https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;500;600;700;800&display=swap');
          .font-quran { font-family: 'Amiri', serif; line-height: 2.4; }
          .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        `}</style>
        
        <header className="px-6 py-4 flex items-center justify-between sticky top-0 bg-white/80 backdrop-blur-md z-50 border-b border-gray-100">
          <div className="flex items-center gap-2">
            <div className="w-9 h-9 bg-emerald-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-emerald-200">
              <BookOpen size={20} />
            </div>
            <span className="font-extrabold text-xl text-gray-800 tracking-tight">Murojaah</span>
          </div>
          <button onClick={() => setView('login')} className="bg-gray-900 text-white px-5 py-2.5 rounded-full text-xs font-bold shadow-lg hover:scale-105 active:scale-95 transition flex items-center gap-2">
            <Lock size={14} /> Masuk
          </button>
        </header>
        
        <main className="flex flex-col items-center justify-center pt-10 pb-20 px-6 text-center">
            <div className="w-20 h-20 bg-emerald-50 rounded-full flex items-center justify-center mb-6 animate-bounce">
                <Mic className="text-emerald-600" size={32}/>
            </div>
            <h2 className="text-4xl font-extrabold text-gray-900 mb-4 leading-tight">
                Hafalan Qur'an <br/>
                <span className="text-emerald-600">Lebih Terjaga</span>
            </h2>
            <p className="text-gray-500 text-lg mb-8 max-w-xs mx-auto">
                Platform Cloud untuk merekam, mendengar ulang, dan memeriksa hafalan Anda. Data tersimpan aman.
            </p>
            <button onClick={() => setView('login')} className="w-full max-w-xs bg-emerald-600 text-white py-4 rounded-2xl font-bold text-lg shadow-xl shadow-emerald-200 hover:bg-emerald-700 active:scale-95 transition">
                Mulai Sekarang
            </button>
        </main>

        <div className="border-t border-gray-100 bg-gray-50 pt-8 pb-safe">
            <p className="text-center text-xs font-bold text-gray-400 uppercase tracking-widest mb-6">Preview Mushaf</p>
            <div className="mx-4 rounded-3xl overflow-hidden shadow-2xl border border-gray-200 h-[400px]">
                <QuranReader user={null} subscription={null} />
            </div>
        </div>
      </div>
    );
  }

  if (view === 'login') {
    return <LoginPage onLogin={handleLogin} onBack={() => setView('landing')} />;
  }

  return (
    <div className="bg-white h-[100dvh] flex flex-col font-sans overflow-hidden">
        <style>{`
          @import url('https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;500;600;700;800&display=swap');
          .font-quran { font-family: 'Amiri', serif; line-height: 2.4; }
          .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        `}</style>

        <div className="flex-1 overflow-hidden relative">
            {activeTab === 'quran' && (
                <QuranReader user={user} subscription={subscription} />
            )}
            {activeTab === 'profile' && (
                <SubscriptionDashboard user={user} subscription={subscription} onLogout={handleLogout} />
            )}
        </div>

        <div className="shrink-0 bg-white border-t border-gray-100 flex justify-around py-3 pb-safe z-50 shadow-[0_-10px_40px_rgba(0,0,0,0.03)]">
            <button onClick={() => setActiveTab('quran')} className={`flex flex-col items-center gap-1.5 px-6 py-1 rounded-2xl transition active:scale-90 ${activeTab === 'quran' ? 'text-emerald-600 bg-emerald-50' : 'text-gray-400 hover:text-gray-600'}`}>
                <Book className={activeTab === 'quran' ? "fill-current" : ""} size={24} strokeWidth={2} />
                <span className="text-[10px] font-bold">Al-Qur'an</span>
            </button>
            <button onClick={() => setActiveTab('profile')} className={`flex flex-col items-center gap-1.5 px-6 py-1 rounded-2xl transition active:scale-90 ${activeTab === 'profile' ? 'text-emerald-600 bg-emerald-50' : 'text-gray-400 hover:text-gray-600'}`}>
                <User className={activeTab === 'profile' ? "fill-current" : ""} size={24} strokeWidth={2} />
                <span className="text-[10px] font-bold">Akun</span>
            </button>
        </div>
    </div>
  );
}